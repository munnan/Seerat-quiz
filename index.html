<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Sheet Quiz Generator</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- CRITICAL: html2canvas for Image Generation capability -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom styles for Inter font and general body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to start to prevent content from being too high */
            min-height: 100vh; /* Ensure it takes full viewport height */
            padding: 2rem; /* Add some padding around the content */
            box-sizing: border-box; /* Include padding in element's total width and height */
        }
        .container {
            background-color: #ffffff; /* White background for the main container */
            border-radius: 1rem; /* Rounded corners */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Soft shadow */
            padding: 2.5rem; /* Generous padding */
            max-width: 900px; /* Max width for readability */
            width: 100%; /* Full width on smaller screens */
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Space between sections */
        }
        .form-section, .results-section {
            padding: 1.5rem;
            border: 1px solid #e2e8f0; /* Light border */
            border-radius: 0.75rem;
            background-color: #f8fafc; /* Slightly different background for sections */
        }
        .question-card {
            background-color: #ffffff;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .correct-answer {
            color: #10b981; /* Green for correct answer */
            font-weight: 600;
        }
        .checkbox-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem; /* Space between checkboxes */
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            background-color: #ffffff;
            max-height: 150px; /* Limit height to enable scrolling if many topics */
            overflow-y: auto; /* Enable vertical scrolling */
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            background-color: #e2e8f0; /* Light background for each checkbox item */
        }
        .checkbox-item input[type="checkbox"] {
            cursor: pointer;
        }
        .checkbox-item label {
            cursor: pointer;
            font-size: 0.9rem;
            color: #4a5568;
        }
        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            .container {
                padding: 1.5rem;
            }
            .form-section, .results-section {
                padding: 1rem;
            }
        }

        /* --- STYLES FOR IMAGE GENERATION (Only applied when generating the image) --- */
        .image-export-mode {
            background-color: #ffffff !important; /* Force white background for image */
            box-shadow: none !important; /* Remove shadows */
            border: none !important; /* Remove border */
            padding: 2.5rem; /* Maintain padding for the look */
        }
        #imageExportWrapper {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
        }
        .export-logo-style {
             margin-bottom: 2rem;
             display: flex;
             flex-direction: column;
             align-items: center;
        }
    </style>
</head>
<body dir="rtl">
    <div class="container">
        
        <!-- The critical error message will be inserted here by JavaScript if initialization fails -->
        <div id="criticalErrorDiv" class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg mb-4 text-center text-sm font-semibold hidden" dir="rtl">
             <strong>اہم خرابی:</strong> کوئز ڈیٹا لوڈ کرنے میں ایک سنگین مسئلہ پیش آیا ہے۔ براہ کرم براؤزر کنسول (F12) میں کوئی بھی ایرر چیک کریں۔
        </div>
        
        <!-- START: Logo Insertion -->
        <div class="flex justify-center mb-6"> 
            <img 
                id="alBurhanLogo"
                src="https://www.phedratech.com/assets/images/AL%20BURHAN%20LOGO.png" 
                alt="Al Burhan Logo" 
                class="h-24 w-auto rounded-lg shadow-lg"
                onerror="this.onerror=null;this.src='https://placehold.co/180x96/0173B6/ffffff?text=AL%20BURHAN%20LOGO'; this.classList.add('p-3', 'bg-blue-100');"
            >
        </div>
        <!-- END: Logo Insertion -->
        
        <h1 class="text-4xl font-extrabold text-center text-gray-900">
            البرہان سیرت کوئز
        </h1>

        <div class="form-section text-right">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">سوالنامہ کے اختیارات منتخب کریں</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Column 1: Topic Checkboxes -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">موضوعات منتخب کریں:</label>
                    <div id="topicCheckboxes" class="checkbox-container">
                        <!-- Checkboxes will be dynamically inserted here -->
                        <p class="text-gray-500">موضوعات لوڈ ہو رہے ہیں...</p>
                    </div>
                </div>
                <!-- Column 2: Questions Count and New Answer Display Mode -->
                <div>
                    <!-- Questions Count -->
                    <div>
                        <!-- The maxQuestionsCountSpan will now be updated based on BOTH filters -->
                        <label for="numQuestions" class="block text-sm font-medium text-gray-700 mb-2">سوالات کی تعداد (زیادہ سے زیادہ: <span id="maxQuestionsCount">0</span>):</label>
                        <input type="number" id="numQuestions" min="1" value="5" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    </div>
                    
                    <!-- NEW ANSWER DISPLAY MODE SECTION -->
                    <div class="mt-6"> 
                        <label for="answerDisplayMode" class="block text-sm font-medium text-gray-700 mb-2">جواب دکھانے کا طریقہ:</label>
                        <select id="answerDisplayMode" class="mt-1 block w-full py-2 pl-3 pr-8 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 rounded-md shadow-sm">
                            <option value="all_shuffled_unmarked">تینوں جوابات دکھائیں (ترتیب بدل کر، جوابات غیر نشان زد)</option>
                            <option value="all_shuffled_marked">تینوں جوابات دکھائیں (صحیح جواب کے ساتھ نشان زد)</option>
                            <option value="right_only">صرف صحیح جواب دکھائیں</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- DIFFICULTY FILTER SECTION -->
            <div class="md:col-span-2 mt-4 p-4 border border-indigo-200 rounded-md bg-white">
                <label for="difficultyLevel" class="block text-sm font-medium text-gray-700 mb-2">مشکل کی سطح کے لحاظ سے فلٹر کریں:</label>
                <select id="difficultyLevel" class="py-2 pl-3 pr-8 text-base border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 rounded-md shadow-sm w-full">
                    <!-- Value stores the range: MIN-MAX -->
                    <option value="0-3">آسان</option>
                    <option value="4-6" selected>نارمل</option>
                    <option value="7-8">مشکل</option>
                    <option value="9-10">انتہائی مشکل</option>
                </select>
            </div>
            
            <button id="generateQuizBtn" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 mt-6">
                سوالات بنائیں
            </button>
            <p id="loadingMessage" class="text-center text-indigo-600 mt-4 hidden">ڈیٹا لوڈ ہو رہا ہے...</p>
            <p id="errorMessage" class="text-center text-red-600 mt-4 hidden"></p>
        </div>

        <div class="results-section hidden text-right" id="resultsSection">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">تیار کردہ سوالات</h2>
            <div id="quizOutput" class="space-y-4">
                <!-- Quiz questions will be inserted here -->
            </div>
            <!-- Container for Copy and Download Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center mt-6">
                <button id="copyToClipboardBtn" class="w-full sm:w-1/2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1">
                    سوالات کو کلپ بورڈ پر کاپی کریں
                </button>
                 <button id="downloadPdfBtn" class="w-full sm:w-1/2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1">
                    سوالنامے کو تصویر (PNG) میں ڈاؤن لوڈ کریں
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- Configuration: Google Sheet URL and Proxy ---
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT7RuRh0GMvBmq5VykMqhWjGfNqb38zqoMiCHF8UWUSVirk2cInp4AZMN3eOwjyLgCCv6nKsUg-tkts/pub?output=csv';
        const CORS_PROXY_URL = 'https://corsproxy.io/?'; 
        
        // --- Configuration: Column Indexes (0-based) ---
        const COL_INDEX = {
            SERIAL: 0,       
            TOPIC: 1,        
            QUESTION: 2,     
            RIGHT_ANSWER: 3, 
            WRONG_ANSWER_1: 4, 
            WRONG_ANSWER_2: 5, 
            DIFFICULTY: 6,   
        };
        const MIN_COLUMNS_REQUIRED = COL_INDEX.DIFFICULTY + 1;
        // ---------------------------------------------------

        // DOM elements
        const criticalErrorDiv = document.getElementById('criticalErrorDiv'); 
        const topicCheckboxesContainer = document.getElementById('topicCheckboxes');
        const numQuestionsInput = document.getElementById('numQuestions');
        const generateQuizBtn = document.getElementById('generateQuizBtn');
        const quizOutput = document.getElementById('quizOutput');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const resultsSection = document.getElementById('resultsSection');
        const copyToClipboardBtn = document.getElementById('copyToClipboardBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const maxQuestionsCountSpan = document.getElementById('maxQuestionsCount');
        const answerDisplayModeSelect = document.getElementById('answerDisplayMode');
        
        // UPDATED DIFFICULTY ELEMENTS
        const difficultyLevelSelect = document.getElementById('difficultyLevel'); 
        
        const alBurhanLogo = document.getElementById('alBurhanLogo');
        
        let sheetData = []; 
        
        // Function to fetch and parse CSV data using a CORS proxy
        async function fetchSheetData() {
            loadingMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            criticalErrorDiv.classList.add('hidden');
            generateQuizBtn.disabled = true;

            const finalFetchUrl = CORS_PROXY_URL + encodeURIComponent(GOOGLE_SHEET_CSV_URL);

            try {
                const response = await fetch(finalFetchUrl);
                
                if (!response.ok) {
                    const errorDetails = await response.text();
                    console.error('Proxy responded with non-OK status. Details:', errorDetails);
                    throw new Error(`Proxy/HTTP error! Status: ${response.status}.`);
                }
                
                const csvText = await response.text();
                
                if (csvText.length < 50 || csvText.includes('Not Found') || csvText.includes('<html>')) {
                    throw new Error('Retrieved content is not valid CSV data. Check the original Google Sheet URL.');
                }
                
                sheetData = parseCSV(csvText);
                
                if (sheetData.length === 0) {
                     throw new Error('CSV data parsed, but no valid data rows found after skipping headers.');
                }
                
                populateTopics(sheetData);
                // Initial update after data is loaded
                updateMaxQuestionsLimit();
                
            } catch (error) {
                console.error('Error fetching or parsing sheet data:', error);
                errorMessage.textContent = `گوگل شیٹ ڈیٹا لوڈ کرنے میں ناکام رہا (CORS پروکسی کی خرابی): ${error.message}`;
                errorMessage.classList.remove('hidden');
                criticalErrorDiv.classList.remove('hidden'); 
                topicCheckboxesContainer.innerHTML = '<p class="text-red-600">موضوعات لوڈ کرنے میں خرابی۔ اوپر موجود ایرر میسیج دیکھیں۔</p>';
                generateQuizBtn.disabled = true;

            } finally {
                 loadingMessage.classList.add('hidden');
            }
        }

        // Simple CSV parser - returns array of arrays (rows)
        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            if (lines.length <= 1) return [];

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].match(/(?:[^\,"]|"(?:\\.|[^"])*")+/g) || [];
                const cleanedValues = values.map(value => value.trim().replace(/^"(.*)"$/, '$1'));

                if (cleanedValues.length >= MIN_COLUMNS_REQUIRED) {
                    data.push(cleanedValues);
                }
            }
            return data;
        }
        
        // Populate the topic checkboxes
        function populateTopics(data) {
            topicCheckboxesContainer.innerHTML = ''; 
            
            if (data.length === 0) {
                topicCheckboxesContainer.innerHTML = '<p class="text-red-600">CSV میں کوئی ڈیٹا قطار نہیں ملی، یا ڈیٹا قطاروں میں ناکافی کالم ہیں۔</p>';
                generateQuizBtn.disabled = true;
                return;
            }

            const uniqueTopicsMap = new Map();

            data.forEach(row => {
                const serial = String(row[COL_INDEX.SERIAL] || '').trim();
                const topicName = String(row[COL_INDEX.TOPIC] || '').trim();

                if (serial && topicName && !uniqueTopicsMap.has(serial)) {
                     uniqueTopicsMap.set(serial, topicName);
                }
            });

            const uniqueTopicsArray = Array.from(uniqueTopicsMap.entries()).map(([serial, topicName]) => ({
                value: serial, 
                label: `${serial} - ${topicName}`
            }));

            const sortedTopics = uniqueTopicsArray.sort((a, b) => {
                return parseInt(a.value, 10) - parseInt(b.value, 10);
            });


            sortedTopics.forEach(topicObj => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'checkbox-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `topic-${topicObj.value}`;
                checkbox.name = 'topic';
                checkbox.value = topicObj.value;
                checkbox.className = 'form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out rounded';

                const label = document.createElement('label');
                label.htmlFor = `topic-${topicObj.value}`;
                label.textContent = topicObj.label;
                label.className = 'ml-1 text-gray-700';

                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                topicCheckboxesContainer.appendChild(checkboxDiv);
            });

            // Attach listeners to trigger update when topics or difficulty changes
            // CRITICAL UPDATE: Listeners are added here to ensure count updates on filter change.
            topicCheckboxesContainer.addEventListener('change', updateMaxQuestionsLimit);
            difficultyLevelSelect.addEventListener('change', updateMaxQuestionsLimit); 
            
            generateQuizBtn.disabled = false;
        }

        /**
         * Filters the sheet data based on currently selected topics AND difficulty level.
         * This function is the single source of truth for available questions.
         */
        function getFilteredQuestions() {
            // 1. Get Topic Filters (using Serial #)
            const selectedTopicCheckboxes = document.querySelectorAll('#topicCheckboxes input[name="topic"]:checked');
            const selectedTopics = Array.from(selectedTopicCheckboxes).map(checkbox => checkbox.value);

            // If no topics selected, return empty array immediately
            if (selectedTopics.length === 0) {
                 return [];
            }

            // 2. Get Difficulty Filters
            const difficultyRange = difficultyLevelSelect.value.split('-'); 
            const minDifficulty = parseInt(difficultyRange[0] || 0, 10);
            const maxDifficulty = parseInt(difficultyRange[1] || 10, 10);


            // Filter logic
            const filtered = sheetData.filter(row => {
                // Topic Filter: Check if the question's Serial # (Index 0) is one of the selected topics
                const serial = String(row[COL_INDEX.SERIAL]).trim();
                const topicMatch = selectedTopics.includes(serial); 
                if (!topicMatch) return false;

                // Difficulty Filter: Check against Difficulty Level (Index 6)
                // Use default 0 if the difficulty column is empty or invalid
                const questionDifficulty = parseInt(row[COL_INDEX.DIFFICULTY] || 0, 10);
                
                // Only keep questions where difficulty is within the selected range (inclusive)
                const difficultyMatch = (questionDifficulty >= minDifficulty && questionDifficulty <= maxDifficulty);
                
                return difficultyMatch;
            });

            return filtered;
        }


        /**
         * Updates the max question count based on the intersection of selected topics and difficulty.
         */
        function updateMaxQuestionsLimit() {
            // CRITICAL FIX: The function now calls getFilteredQuestions(), which applies BOTH filters
            const filteredQuestions = getFilteredQuestions(); 
            const totalAvailableQuestions = filteredQuestions.length;

            numQuestionsInput.max = totalAvailableQuestions;
            maxQuestionsCountSpan.textContent = totalAvailableQuestions;

            const currentValue = parseInt(numQuestionsInput.value, 10);
            
            // Adjust current input value if it exceeds the new maximum or is less than 1
            if (currentValue > totalAvailableQuestions || currentValue < 1) {
                numQuestionsInput.value = totalAvailableQuestions > 0 ? 1 : 0;
            }
            
            if (totalAvailableQuestions === 0) {
                numQuestionsInput.value = 0;
                generateQuizBtn.disabled = true;
            } else {
                generateQuizBtn.disabled = false;
            }
        }

        // Function to shuffle an array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Generate and display quiz questions
        function generateQuiz() {
            quizOutput.innerHTML = '';
            resultsSection.classList.add('hidden');
            errorMessage.classList.add('hidden');

            const selectedTopicCheckboxes = document.querySelectorAll('#topicCheckboxes input[name="topic"]:checked');
            const numQuestions = parseInt(numQuestionsInput.value, 10);

            if (selectedTopicCheckboxes.length === 0) {
                errorMessage.textContent = 'براہ کرم کم از کم ایک موضوع منتخب کریں۔';
                errorMessage.classList.remove('hidden');
                return;
            }
            if (isNaN(numQuestions) || numQuestions <= 0) {
                errorMessage.textContent = 'براہ کرم سوالات کی ایک درست تعداد (1 یا اس سے زیادہ) درج کریں۔';
                errorMessage.classList.remove('hidden');
                return;
            }

            const filteredQuestions = getFilteredQuestions();
            const displayMode = answerDisplayModeSelect.value; 

            if (filteredQuestions.length === 0) {
                errorMessage.textContent = `منتخب کردہ موضوع(موضوعات) اور مشکل کی سطح کے فلٹر سے مماثل کوئی سوال نہیں ملا۔`;
                errorMessage.classList.remove('hidden');
                return;
            }

            const shuffledQuestions = filteredQuestions.sort(() => 0.5 - Math.random());
            const questionsToDisplay = shuffledQuestions.slice(0, numQuestions);

            if (questionsToDisplay.length === 0) {
                errorMessage.textContent = `${numQuestions} سوالات تیار نہیں کیے جا سکے۔ فلٹرنگ کے بعد صرف ${filteredQuestions.length} دستیاب ہیں۔`;
                errorMessage.classList.remove('hidden');
                return;
            }

            questionsToDisplay.forEach((q, index) => {
                const questionText = q[COL_INDEX.QUESTION] || 'کوئی سوال دستیاب نہیں';
                const topicText = q[COL_INDEX.TOPIC] || ''; 
                
                const rightAnswer = q[COL_INDEX.RIGHT_ANSWER] || 'N/A';
                const wrongAnswer1 = q[COL_INDEX.WRONG_ANSWER_1] || 'N/A';
                const wrongAnswer2 = q[COL_INDEX.WRONG_ANSWER_2] || 'N/A';

                let answers = [];

                if (displayMode === 'right_only') {
                    answers = [rightAnswer].filter(a => a !== 'N/A' && a !== '');
                } else {
                    answers = [rightAnswer, wrongAnswer1, wrongAnswer2].filter(a => a !== 'N/A' && a !== '');
                    shuffleArray(answers);
                }


                let answersHtml = '';
                answers.forEach(answer => {
                    let displayClass = '';
                    let rightAnswerLabel = '';
                    
                    if (answer === rightAnswer && (displayMode === 'right_only' || displayMode === 'all_shuffled_marked')) {
                        displayClass = 'correct-answer';
                        rightAnswerLabel = ' (صحیح جواب)';
                    }
                    
                    answersHtml += `<li dir="rtl"><span class="${displayClass}">${answer}${rightAnswerLabel}</span></li>`;
                });


                const questionCard = document.createElement('div');
                questionCard.className = 'question-card text-right';
                
                const topicDisplay = topicText ? ` <span class="quiz-topic-text text-sm font-normal text-gray-500">(${topicText})</span>` : '';
                const fullQuestionText = `${questionText}${topicDisplay}`;

                questionCard.innerHTML = `
                    <p class="text-lg font-semibold text-gray-900 mb-2">سوال ${index + 1}: ${fullQuestionText}</p>
                    <ul class="list-disc list-inside text-gray-700">
                        ${answersHtml}
                    </ul>
                `;
                quizOutput.appendChild(questionCard);
            });
            resultsSection.classList.remove('hidden');
        }

        // Download Quiz as PNG Image
        function downloadQuizAsImage() {
            if (typeof html2canvas === 'undefined') {
                errorMessage.textContent = 'تصویر تیار کرنے کے لیے html2canvas لائبریری دستیاب نہیں ہے۔';
                errorMessage.classList.remove('hidden');
                return;
            }

            downloadPdfBtn.textContent = 'تصویر تیار ہو رہی ہے...';
            downloadPdfBtn.disabled = true;
            errorMessage.classList.add('hidden');

            const imageContainer = document.createElement('div');
            imageContainer.id = 'imageExportWrapper';
            imageContainer.style.width = '800px'; 
            imageContainer.style.position = 'absolute';
            imageContainer.style.left = '-9999px'; 

            const clonedResults = resultsSection.cloneNode(true);
            clonedResults.classList.add('image-export-mode');
            clonedResults.querySelector('.flex')?.remove(); 
            
            const exportHeader = document.createElement('div');
            exportHeader.className = 'export-logo-style text-center mb-6';
            
            const headerLogo = alBurhanLogo.cloneNode(true);
            headerLogo.classList.remove('shadow-lg');
            headerLogo.classList.remove('h-24');
            headerLogo.classList.add('h-16', 'w-auto');
            headerLogo.removeAttribute('onerror');

            const headerTitle = document.createElement('h1');
            headerTitle.className = 'text-3xl font-extrabold text-gray-900 mt-2';
            headerTitle.textContent = 'البرہان سیرت کوئز';
            
            exportHeader.appendChild(headerLogo);
            exportHeader.appendChild(headerTitle);

            imageContainer.appendChild(exportHeader);
            imageContainer.appendChild(clonedResults);
            
            document.body.appendChild(imageContainer);

            html2canvas(imageContainer, {
                scale: 2, 
                logging: false,
                useCORS: true,
                allowTaint: true
            }).then(canvas => {
                const imageURL = canvas.toDataURL('image/png');
                const filename = `AlBurhan_Quiz_${new Date().toISOString().slice(0, 10)}.png`;

                const link = document.createElement('a');
                link.href = imageURL;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                downloadPdfBtn.textContent = 'سوالنامے کو تصویر (PNG) میں ڈاؤن لوڈ کریں';
                downloadPdfBtn.disabled = false;
            }).catch(error => {
                console.error('Image Generation failed:', error);
                downloadPdfBtn.textContent = 'تصویر تیار نہیں ہو سکی';
                downloadPdfBtn.disabled = false;
                errorMessage.textContent = 'تصویر تیار کرنے میں کوئی مسئلہ پیش آیا۔ کنسول میں تفصیلات دیکھیں۔';
                errorMessage.classList.remove('hidden');
            }).finally(() => {
                if (document.body.contains(imageContainer)) {
                    document.body.removeChild(imageContainer);
                }
            });
        }


        // Function to copy generated questions to clipboard
        function copyQuestionsToClipboard() {
            let textToCopy = '';
            const displayMode = document.getElementById('answerDisplayMode').value;
            
            const questionCards = quizOutput.querySelectorAll('.question-card');
            questionCards.forEach((card, index) => {
                const questionTextElement = card.querySelector('p:nth-child(1)'); 
                let rawQuestionText = questionTextElement ? questionTextElement.textContent.replace(/^سوال \d+:\s*/, '') : '';
                
                const topicSpan = questionTextElement ? questionTextElement.querySelector('.quiz-topic-text') : null;
                let topicInBrackets = '';
                if (topicSpan) {
                     topicInBrackets = topicSpan.textContent;
                     rawQuestionText = rawQuestionText.replace(topicInBrackets, '').trim(); 
                }

                const answers = Array.from(card.querySelectorAll('li span')).map(span => {
                    return span.textContent;
                });

                textToCopy += `سوال ${index + 1}: ${rawQuestionText} ${topicInBrackets}\n`;
                
                if (displayMode === 'right_only' && answers.length > 0) {
                    const rightAnswerText = answers[0];
                    textToCopy += `  صحیح جواب: ${rightAnswerText}\n`;
                } else if (answers.length > 0) {
                    answers.forEach(answer => {
                        const cleanAnswer = answer.replace(' (صحیح جواب)', '').trim();
                        textToCopy += `  - ${cleanAnswer}\n`;
                    });
                }
                textToCopy += '\n';
            });

            const textarea = document.createElement('textarea');
            textarea.value = textToCopy;
            textarea.style.position = 'fixed';
            textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();

            try {
                const successful = document.execCommand('copy');
                const msg = successful ? 'کلپ بورڈ پر کاپی ہو گیا!' : 'کاپی کرنے میں ناکام!';
                copyToClipboardBtn.textContent = msg;
                setTimeout(() => {
                    copyToClipboardBtn.textContent = 'سوالات کو کلپ بورڈ پر کاپی کریں';
                }, 2000);
            } catch (err) {
                console.error('Oops, unable to copy', err);
                copyToClipboardBtn.textContent = 'کاپی میں ناکامی!';
                setTimeout(() => {
                    copyToClipboardBtn.textContent = 'سوالات کو کلپ بورڈ پر کاپی کریں';
                }, 2000);
            } finally {
                document.body.removeChild(textarea);
            }
        }
        
        // Event Listeners
        generateQuizBtn.addEventListener('click', generateQuiz);
        copyToClipboardBtn.addEventListener('click', copyQuestionsToClipboard);
        downloadPdfBtn.addEventListener('click', downloadQuizAsImage); 
        
        // Initial data fetch on page load
        window.onload = fetchSheetData;
    </script>
</body>
</html>
